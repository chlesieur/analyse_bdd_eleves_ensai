---
title: "Analyse_statistique"
format: html
---

```{r}
library(dplyr)
library(ggplot2)
library(readr)
library(tidyr)
library(forcats)
library(arrow)
library(scales)

bdd <- read_parquet("Z:/0_Direction_des_Etudes/Base élève/analyse_bdd_eleves_ensai/data/bdd_2015_2024.parquet")

bdd_2 <-  bdd %>% 
  filter(annee_ecole != "Autres")

```

### Nombre d'étudiants par année en 1A, 2A et 3A

```{r}

nb_eleve_par_annee <- bdd_2 %>% 
  distinct(id_crypte, annee, annee_ecole) %>%
  count(annee, annee_ecole) %>%                   
  pivot_wider(
    names_from  = annee_ecole,                    
    values_from = n,
    names_prefix = "nb_",
    values_fill = 0
  )

nb_eleve_par_annee

```

```{r}

nb_eleve_par_annee %>% 
  pivot_longer(-annee, names_to = "niveau", values_to = "effectif") |>
  mutate(niveau = recode(niveau,
                         nb_1A = "1A",
                         nb_2A = "2A",
                         nb_3A = "3A")) |>
  ggplot(aes(x = factor(annee), y = effectif, fill = niveau)) +
  geom_col(position = position_dodge(width = 0.8)) +
  geom_text(aes(label = comma(effectif)),           # comma() trouvé car scales chargé
            position = position_dodge(width = 0.8),
            vjust = -0.3, size = 3) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)),
                     labels = comma) +
  scale_fill_brewer(palette = "Set2", name = "Niveau") +
  labs(title = "Effectifs par année et par niveau",
       x = "Année universitaire",
       y = "Nombre d'étudiants") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "top")

```
```{r}
nb_par_cpge <- bdd_2 %>% 
  filter(annee_ecole == "1A") %>% 
  distinct(id_crypte, annee, cpge) %>%  
  count(annee, cpge, name = "n") %>%      
  pivot_wider(                                 
    names_from  = cpge,
    values_from = n,
    names_prefix = "nb_",
    values_fill  = 0
  )

nb_par_cpge

```

```{r}

moyennes_2A <- bdd_2 %>% 
  filter(annee_ecole == "2A") %>%              # ← on garde seulement les 2A   # échelle 0-20
  group_by(annee, cpge) %>% 
  summarise(
    nb_etudiants = n_distinct(id_crypte),
    moy_generale = round(mean(moyenne_generale, na.rm = TRUE), 2),
    .groups = "drop"
  )

moyennes_2A

```

```{r}
moyennes_2A <- bdd_2 %>% 
  filter(annee_ecole == "2A") %>%                       # uniquement les 2A
  mutate(moyenne_generale = moyenne_generale) %>% # notes ramenées sur 20
  group_by(annee, cpge) %>% 
  summarise(
    nb_etudiants = n_distinct(id_crypte),
    moy_generale = mean(moyenne_generale, na.rm = TRUE),
    .groups = "drop"
  ) %>% 
  mutate(label = round(moy_generale, 1))                # étiquette « 12,3 »

# ── 2. Construction du graphique ────────────────────────────────────────────
p <- ggplot(moyennes_2A,
            aes(x = factor(annee),
                y = moy_generale,
                fill = cpge)) +
  geom_col(position = position_dodge(width = .8), width = .7) +
  geom_text(aes(label = sprintf("%.1f", label)),
            position = position_dodge(width = .8),
            vjust = -0.3, size = 3, colour = "black") +
  scale_y_continuous(
    labels = number_format(accuracy = 0.1),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_fill_viridis_d(option = "plasma", name = "cpge") +
  labs(
    title    = "Moyenne générale (sur 20) des 2A par voie d’admission",
    x        = "Année universitaire",
    y        = "Moyenne générale"
  ) +
  theme_classic(base_size = 12) +
  theme(
    legend.position    = "bottom",
    panel.grid.major.y = element_line(colour = "grey90")
  )

print(p)   # aperçu à l’écran

```
