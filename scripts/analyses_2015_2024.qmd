---
title: "Analyses sur la période 2015-2024"
format: html
---

```{r}
library(dplyr)
library(ggplot2)
library(readr)
library(tidyr)
library(forcats)
library(arrow)
library(scales)
library(knitr)
library(kableExtra)
library(readxl)

bdd <- read_parquet("Z:/0_Direction_des_Etudes/Base_eleve/data/bdd_2015_2024.parquet") %>% filter(annee_ecole != "Autres")

# creation boucles sortie stat par bloc annee
bdd$bloc_an<- ifelse(bdd$annee %in% c(2015,2016,2017),"2015-2017",ifelse (bdd$annee %in% c(2018,2019,2020),"2018-2020",ifelse(bdd$annee %in% c(2021,2022),"2021-2022","2023-2024")))

# travaux sur 1A et 2A
bdd_1A_2A <- bdd[bdd$annee_ecole %in% c("1A","2A"),]

#  conserver une ligne par eleve et par année
bdd_1A_2A_unique <- bdd_1A_2A[!duplicated(cbind(bdd_1A_2A$id_crypte,bdd_1A_2A$annee)),]

bdd_bloc_1A_2A <- bdd_1A_2A_unique %>%
  filter(annee_ecole %in% c("1A","2A")) %>%
  group_by(bloc_an, annee_ecole, spe_entree) %>%
  summarise(
    nb       = n(),
    
    # Moyennes
    moy_g    = round(mean(moyenne_generale, na.rm = TRUE), 1),
    moy_stat = round((mean(MSS1, na.rm = TRUE) + mean(MSS2, na.rm = TRUE)) / 2, 1),
    moy_eco  = round((mean(MES1, na.rm = TRUE) + mean(MES2, na.rm = TRUE)) / 2, 1),
    moy_info = round((mean(MIS1, na.rm = TRUE) + mean(MIS2, na.rm = TRUE)) / 2, 1),
    moy_hum  = round((mean(MHS1, na.rm = TRUE) + mean(MHS2, na.rm = TRUE)) / 2, 1),
    
    # Proportions < 12 (en %)
    prop12_g    = round(100 * mean(moyenne_generale < 12, na.rm = TRUE), 1),
    prop12_stat = round(100 * mean((MSS1 + MSS2)/2 < 12, na.rm = TRUE), 1),
    prop12_eco  = round(100 * mean((MES1 + MES2)/2 < 12, na.rm = TRUE), 1),
    prop12_info = round(100 * mean((MIS1 + MIS2)/2 < 12, na.rm = TRUE), 1),
    prop12_hum  = round(100 * mean((MHS1 + MHS2)/2 < 12, na.rm = TRUE), 1),
    
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from  = spe_entree,
    values_from = c(nb, moy_g, moy_stat, moy_eco, moy_info, moy_hum,
                    prop12_g, prop12_stat, prop12_eco, prop12_info, prop12_hum),
    values_fill = 0
  ) %>%
  arrange(bloc_an, annee_ecole)

# travaux sur 3A
bdd_3A_ing <- bdd[bdd$annee_ecole=="3A" & !is.na(bdd$filiere_3A) & bdd$att_ing=="ingénieur",]

#  conserver une ligne par eleve et par année
bdd_3A_ing <- bdd_3A_ing[!duplicated(cbind(bdd_3A_ing$id_crypte,bdd_3A_ing$annee)),]

# recoder filiere 3A pour pb sur autres et pb sur nom filiere (regroupement)
bdd_3A$fil_3A <- ifelse(bdd_3A$filiere_3A == "Autres" & bdd_3A$voie_lib %in% c("3A,3A GDRIF","3A,3A GDRIF,OFPR","3A,3A GR", "3A,3A GR,3A Ing,OFPR,T00000","3A,3A GR,3A Ing,T00000","3A,3A GR,3A Ing,T01850","3A,3A GR,3A Ing,T02650","3A,3A GR,CVEC","3A,3A GR,CVEC,OFPR","3A,3A GR,CVEC,OFPR,Tpoursuite","3A,3A GR,CVEC,Tpoursuite","3A,3A GR,OFPR"),"GDR",ifelse(bdd_3A$filiere_3A == "Autres" & bdd_3A$voie_lib %in% c("3A,3A Ing,3A SBio,OFPR,T00000","3A,3A Ing,3A SBio,OFPR,T01850","3A,3A Ing,3A SBio,T00000","3A,3A Ing,3A SBio,T01850","3A,3A SBio","3A,3A SBio,CVEC","3A,3A SBio,CVEC,OFPR","3A,3A SBio,CVEC,OFPR,Tpoursuite","3A,3A SBio,CVEC,Tpoursuite","3A,3A SBio,OFPR","3A,3A SBio,OFPR,Tpoursuite","3A,3A SBio,T00000"),"SBio",ifelse(bdd_3A$filiere_3A == "M","MKT",ifelse(bdd_3A$filiere_3A == "SV","SBio",ifelse(bdd_3A$filiere_3A == "ISTS","MES",bdd_3A$filiere_3A)))))

```

## 1. Données de cadrage

### 1.1. Nombre d'étudiants par année

```{r}

nb_eleve_par_annee <- bdd %>% 
  distinct(id_crypte, annee, annee_ecole) %>%
  count(annee, annee_ecole) %>%                   
  pivot_wider(
    names_from  = annee_ecole,                    
    values_from = n,
    names_prefix = "nb_",
    values_fill = 0
  )

nb_eleve_par_annee %>%
  kable(format = "html", caption = "Nombre d'élèves par année et niveau") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE, position = "center")

```

```{r}

nb_eleve_par_annee %>% 
  pivot_longer(-annee, names_to = "niveau", values_to = "effectif") |>
  mutate(niveau = recode(niveau,
                         nb_1A = "1A",
                         nb_2A = "2A",
                         nb_3A = "3A")) |>
  ggplot(aes(x = factor(annee), y = effectif, fill = niveau)) +
  geom_col(position = position_dodge(width = 0.8)) +
  geom_text(aes(label = comma(effectif)), 
            position = position_dodge(width = 0.8),
            vjust = -0.3, size = 3) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)),
                     labels = comma) +
  scale_fill_brewer(palette = "Set2", name = "Niveau") +
  labs(title = "Effectifs par année et par niveau",
       x = "Année universitaire",
       y = "Nombre d'étudiants") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "top")

```

### 1.2. Nombre d'étudiants par sexe

```{r}

# Calcul des % H/F
pct_eleve_par_annee <- bdd %>% 
  distinct(id_crypte, annee, annee_ecole, sexe) %>%
  count(annee, annee_ecole, sexe) %>%
  group_by(annee, annee_ecole) %>%
  mutate(
    pct = round(100 * n / sum(n), 1)  # % par sexe dans chaque (année, niveau)
  ) %>%
  ungroup() %>%
  select(-n) %>%  # ⬅️ on enlève les effectifs, on garde seulement les %
  pivot_wider(
    names_from = c(annee_ecole, sexe),
    values_from = pct,
    values_fill = 0
  )

# Tableau HTML avec kable
pct_eleve_par_annee %>%
  kable(format = "html", caption = "% d'élèves par année - niveau - sexe") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center"
  )

```

### 1.3. Nombre d'étudiants par statut

```{r}

nb_eleve_par_annee <- bdd %>% 
  distinct(id_crypte, annee, annee_ecole, att_ing) %>%
  count(annee, annee_ecole, att_ing) %>%                   
  pivot_wider(
    names_from  = annee_ecole,                    
    values_from = n,
    names_prefix = "nb_",
    values_fill = 0
  )

nb_eleve_par_annee %>%
  kable(format = "html", caption = "Nombre d'élèves par année - niveau - statut") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE, position = "center")

```

### 1.4. Nombre de redoublements par année

```{r}

nb_eleve_par_annee <- bdd %>% 
  distinct(id_crypte, annee, annee_ecole, redoublement) %>%
  count(annee, annee_ecole, redoublement) %>%                   
  pivot_wider(
    names_from  = annee_ecole,                    
    values_from = n,
    names_prefix = "nb_",
    values_fill = 0
  )

nb_eleve_par_annee %>%
  filter(redoublement == 1) %>% 
  kable(format = "html", caption = "Nombre d'élèves par année - niveau - statut") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE, position = "center")

```

### 1.5. Nombre d'exclusions par année

```{r}

nb_eleve_par_annee <- bdd %>% 
  distinct(id_crypte, annee, annee_ecole, exclusion) %>%
  count(annee, annee_ecole, exclusion) %>%                   
  pivot_wider(
    names_from  = annee_ecole,                    
    values_from = n,
    names_prefix = "nb_",
    values_fill = 0
  )

nb_eleve_par_annee %>%
  filter(exclusion == 1) %>% 
  kable(format = "html", caption = "Nombre d'élèves par année - niveau - statut") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE, position = "center")

```

### 1.6. Répartition des spécialisation entre troisième année


```{r}

nb_eleves_3A_ing <- bdd_3A %>% 
  distinct(id_crypte, annee, fil_3A) %>%
  count(annee, fil_3A) %>%                   
  pivot_wider(
    names_from  = fil_3A,                    
    values_from = n,
    names_prefix = "nb_",
    values_fill = 0
  )

nb_eleves_3A_ing %>%
  kable(format = "html", caption = "Nombre d'élèves par filière 3A") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE, position = "center")

```

```{r}

# Données en format long avec % par année
nb_eleves_3A_long <- bdd_3A %>% 
  distinct(id_crypte, annee, fil_3A) %>%
  count(annee, fil_3A) %>%
  group_by(annee) %>%
  mutate(
    pct = 100 * n / sum(n)
  ) %>%
  ungroup()

# Graphique empilé base 100 %
ggplot(nb_eleves_3A_long, aes(x = factor(annee), y = pct, fill = fil_3A)) +
  geom_col(position = "stack") +
  geom_text(aes(label = paste0(round(pct, 1), "%")),
            position = position_stack(vjust = 0.5), size = 3, color = "white") +
  labs(
    title = "Répartition des élèves par filière 3A (en %)",
    x = "Année",
    y = "Pourcentage",
    fill = "Filière 3A"
  ) +
  scale_y_continuous(labels = function(x) paste0(x, "%")) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 30, hjust = 1)
  )

```

## 2. Spécialité à l'entrée et scolarité à l'ENSAI

### 2.1. Évolution des effectifs selon la spécialité à l'entrée

### 2.1.1. En première année

- En effectifs

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole,contains("nb_")) %>%  
  filter(annee_ecole == "1A") %>% 
  arrange(desc(bloc_an)) %>%  
  kable(format = "html", caption = "Nombre d'élèves selon la filière d'entrée",
        align = "c") %>%  
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em")

```

- En taux

```{r}
taux_1A <- bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole,contains("nb_")) %>%  
  filter(annee_ecole == "1A") %>%
  arrange(desc(bloc_an)) %>%
  # calcul du total ligne
  mutate(Total = rowSums(select(., where(is.numeric)), na.rm = TRUE)) %>%
  # calcul des pourcentages (sauf bloc_an, annee_ecole, Total)
  mutate(across(-c(bloc_an, annee_ecole, Total), ~ round(.x / Total * 100, 1))) %>%
  select(-Total)

taux_1A %>%
  arrange(desc(bloc_an)) %>%   # tri inverse sur bloc_an
  kable(format = "html", caption = "Répartition selon la filière d'entrée",
        align = "c") %>%       # toutes les colonnes centrées
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em") 

```

- Graphique

```{r}

taux_1A_long <- taux_1A %>%
  pivot_longer(
    cols = -c(bloc_an, annee_ecole),
    names_to = "spe_entree",
    values_to = "pct"
  )

ggplot(taux_1A_long, aes(x = bloc_an, y = pct, fill = spe_entree)) +
  geom_col(position = "stack") +
  geom_text(aes(label = paste0(pct, "%")),
            position = position_stack(vjust = 0.5),
            size = 3, color = "white") +
  labs(
    title = "Répartition des élèves de 1A par filière d'entrée (%)",
    x = "Année",
    y = "Part des élèves (%)",
    fill = "Filière d'entrée"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "right")
```

### 2.1.2 En deuxième année

- En effectifs

```{r}

bdd_bloc_1A_2A %>%
    select(bloc_an, annee_ecole,contains("nb_")) %>%  
  filter(annee_ecole == "2A") %>%
  arrange(desc(bloc_an)) %>%  
  kable(format = "html", caption = "Nombre d'élèves selon la filière d'entrée",
        align = "c") %>%       
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em")   

```

- En taux

```{r}
taux_2A <- bdd_bloc_1A_2A %>%
    select(bloc_an, annee_ecole,contains("nb_")) %>%  
  filter(annee_ecole == "2A") %>%
  arrange(desc(bloc_an)) %>%
  # calcul du total ligne
  mutate(Total = rowSums(select(., where(is.numeric)), na.rm = TRUE)) %>%
  # calcul des pourcentages (sauf bloc_an, annee_ecole, Total)
  mutate(across(-c(bloc_an, annee_ecole, Total), ~ round(.x / Total * 100, 1))) %>%
  select(-Total)

taux_2A %>%
  arrange(desc(bloc_an)) %>%   # tri inverse sur bloc_an
  kable(format = "html", caption = "Répartition selon la filière d'entrée",
        align = "c") %>%       # toutes les colonnes centrées
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em") 

```

```{r}
# On part de taux_1A et on repasse en format long
taux_2A_long <- taux_2A %>%
  pivot_longer(
    cols = -c(bloc_an, annee_ecole),
    names_to = "spe_entree",
    values_to = "pct"
  )

# Graphique : barres empilées en % par année
ggplot(taux_2A_long, aes(x = bloc_an, y = pct, fill = spe_entree)) +
  geom_col(position = "stack") +
  geom_text(aes(label = paste0(pct, "%")),
            position = position_stack(vjust = 0.5),
            size = 3, color = "white") +
  labs(
    title = "Répartition des élèves de 1A par filière d'entrée (%)",
    x = "Année",
    y = "Part des élèves (%)",
    fill = "Filière d'entrée"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "right")

```

## 2.2. Moyenne des élèves selon la spécialité à l'entrée

### 2.2.1. En première année

- Moyenne générale

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole,contains("moy_g"), -c("moy_stat_AST 2A")) %>%  
  filter(annee_ecole == "1A") %>% 
  arrange(desc(bloc_an)) %>%  
  kable(format = "html", caption = "Nombre d'élèves selon la filière d'entrée",
        align = "c") %>%  
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em")

```

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole, contains("moy_g"), -c("moy_g_AST 2A")) %>%
  filter(annee_ecole == "1A") %>%
  arrange(desc(bloc_an)) %>%
  pivot_longer(
    cols = contains("moy_g"),
    names_to = "filiere",
    values_to = "moyenne"
  ) %>%
  ggplot(aes(x = filiere, y = moyenne, fill = bloc_an)) +
  geom_col(position = "dodge") +
  labs(
    title = "1A : Moyennes Générales",
    x = "Filière d'entrée",
    y = "Moyenne"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

```

- UE Stat

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole,contains("moy_stat"), -c("moy_stat_AST 2A")) %>%  
  filter(annee_ecole == "1A") %>% 
  arrange(desc(bloc_an)) %>%  
  kable(format = "html", caption = "Nombre d'élèves selon la filière d'entrée",
        align = "c") %>%  
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em")

```

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole, contains("moy_stat"), -c("moy_stat_AST 2A")) %>%
  filter(annee_ecole == "1A") %>%
  arrange(desc(bloc_an)) %>%
  pivot_longer(
    cols = contains("moy_stat"),
    names_to = "filiere",
    values_to = "moyenne"
  ) %>%
  ggplot(aes(x = filiere, y = moyenne, fill = bloc_an)) +
  geom_col(position = "dodge") +
  labs(
    title = "1A : Moyennes UE Stat",
    x = "Filière d'entrée",
    y = "Moyenne"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

```

- UE Info

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole,contains("moy_inf"), -c("moy_stat_AST 2A")) %>%  
  filter(annee_ecole == "1A") %>% 
  arrange(desc(bloc_an)) %>%  
  kable(format = "html", caption = "Nombre d'élèves selon la filière d'entrée",
        align = "c") %>%  
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em")
```

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole, contains("moy_info"), -c("moy_info_AST 2A")) %>%
  filter(annee_ecole == "1A") %>%
  arrange(desc(bloc_an)) %>%
  pivot_longer(
    cols = contains("moy_info"),
    names_to = "filiere",
    values_to = "moyenne"
  ) %>%
  ggplot(aes(x = filiere, y = moyenne, fill = bloc_an)) +
  geom_col(position = "dodge") +
  labs(
    title = "1A : Moyennes UE Info",
    x = "Filière d'entrée",
    y = "Moyenne"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

```

- UE Éco

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole,contains("moy_eco"), -c("moy_stat_AST 2A")) %>%  
  filter(annee_ecole == "1A") %>% 
  arrange(desc(bloc_an)) %>%  
  kable(format = "html", caption = "Nombre d'élèves selon la filière d'entrée",
        align = "c") %>%  
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em")
```

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole, contains("moy_eco"), -c("moy_eco_AST 2A")) %>%
  filter(annee_ecole == "1A") %>%
  arrange(desc(bloc_an)) %>%
  pivot_longer(
    cols = contains("moy_eco"),
    names_to = "filiere",
    values_to = "moyenne"
  ) %>%
  ggplot(aes(x = filiere, y = moyenne, fill = bloc_an)) +
  geom_col(position = "dodge") +
  labs(
    title = "1A : Moyennes UE Éco",
    x = "Filière d'entrée",
    y = "Moyenne"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

```

- UE Humanités

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole,contains("moy_hum"), -c("moy_hum_AST 2A")) %>%  
  filter(annee_ecole == "1A") %>% 
  arrange(desc(bloc_an)) %>%  
  kable(format = "html", caption = "Nombre d'élèves selon la filière d'entrée",
        align = "c") %>%  
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em")
```

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole, contains("moy_hum"), -c("moy_hum_AST 2A")) %>%
  filter(annee_ecole == "1A") %>%
  arrange(desc(bloc_an)) %>%
  pivot_longer(
    cols = contains("moy_hum"),
    names_to = "filiere",
    values_to = "moyenne"
  ) %>%
  ggplot(aes(x = filiere, y = moyenne, fill = bloc_an)) +
  geom_col(position = "dodge") +
  labs(
    title = "1A : Moyennes UE Humanités",
    x = "Filière d'entrée",
    y = "Moyenne"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

```


### 2.2.2. En deuxième année

- Moyenne générale

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole,contains("moy_g")) %>%  
  filter(annee_ecole == "2A") %>% 
  arrange(desc(bloc_an)) %>%  
  kable(format = "html", caption = "Nombre d'élèves selon la filière d'entrée",
        align = "c") %>%  
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em")

```

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole, contains("moy_g")) %>%
  filter(annee_ecole == "2A") %>%
  arrange(desc(bloc_an)) %>%
  pivot_longer(
    cols = contains("moy_g"),
    names_to = "filiere",
    values_to = "moyenne"
  ) %>%
  ggplot(aes(x = filiere, y = moyenne, fill = bloc_an)) +
  geom_col(position = "dodge") +
  labs(
    title = "1A : Moyennes Générales",
    x = "Filière d'entrée",
    y = "Moyenne"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

```


- UE Stat

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole,contains("moy_stat")) %>%  
  filter(annee_ecole == "2A") %>% 
  arrange(desc(bloc_an)) %>%  
  kable(format = "html", caption = "Nombre d'élèves selon la filière d'entrée",
        align = "c") %>%  
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em")

```

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole, contains("moy_stat")) %>%
  filter(annee_ecole == "2A") %>%
  arrange(desc(bloc_an)) %>%
  pivot_longer(
    cols = contains("moy_stat"),
    names_to = "filiere",
    values_to = "moyenne"
  ) %>%
  ggplot(aes(x = filiere, y = moyenne, fill = bloc_an)) +
  geom_col(position = "dodge") +
  labs(
    title = "1A : Moyennes UE Stat",
    x = "Filière d'entrée",
    y = "Moyenne"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

```

- UE Info

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole,contains("moy_inf")) %>%  
  filter(annee_ecole == "2A") %>% 
  arrange(desc(bloc_an)) %>%  
  kable(format = "html", caption = "Nombre d'élèves selon la filière d'entrée",
        align = "c") %>%  
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em")
```

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole, contains("moy_info")) %>%
  filter(annee_ecole == "2A") %>%
  arrange(desc(bloc_an)) %>%
  pivot_longer(
    cols = contains("moy_info"),
    names_to = "filiere",
    values_to = "moyenne"
  ) %>%
  ggplot(aes(x = filiere, y = moyenne, fill = bloc_an)) +
  geom_col(position = "dodge") +
  labs(
    title = "1A : Moyennes UE Info",
    x = "Filière d'entrée",
    y = "Moyenne"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

```

- UE Éco

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole,contains("moy_eco")) %>%  
  filter(annee_ecole == "2A") %>% 
  arrange(desc(bloc_an)) %>%  
  kable(format = "html", caption = "Nombre d'élèves selon la filière d'entrée",
        align = "c") %>%  
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em")
```

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole, contains("moy_eco")) %>%
  filter(annee_ecole == "2A") %>%
  arrange(desc(bloc_an)) %>%
  pivot_longer(
    cols = contains("moy_eco"),
    names_to = "filiere",
    values_to = "moyenne"
  ) %>%
  ggplot(aes(x = filiere, y = moyenne, fill = bloc_an)) +
  geom_col(position = "dodge") +
  labs(
    title = "1A : Moyennes UE Éco",
    x = "Filière d'entrée",
    y = "Moyenne"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

```

- UE Humanités

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole,contains("moy_hum")) %>%  
  filter(annee_ecole == "2A") %>% 
  arrange(desc(bloc_an)) %>%  
  kable(format = "html", caption = "Nombre d'élèves selon la filière d'entrée",
        align = "c") %>%  
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em")
```

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole, contains("moy_hum")) %>%
  filter(annee_ecole == "1A") %>%
  arrange(desc(bloc_an)) %>%
  pivot_longer(
    cols = contains("moy_hum"),
    names_to = "filiere",
    values_to = "moyenne"
  ) %>%
  ggplot(aes(x = filiere, y = moyenne, fill = bloc_an)) +
  geom_col(position = "dodge") +
  labs(
    title = "1A : Moyennes UE Humanités",
    x = "Filière d'entrée",
    y = "Moyenne"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

```


## 2.3. Proportion des élèves en difficulté selon la spécialité à l'entrée

Le seuil pour les élèves en difficulté a été fixé à une moyenne inférieure à 12.

### 2.2.1. En première année

- Moyenne générale

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole,contains("prop12_g"), -c("prop12_stat_AST 2A")) %>%  
  filter(annee_ecole == "1A") %>% 
  arrange(desc(bloc_an)) %>%  
  kable(format = "html", caption = "Nombre d'élèves selon la filière d'entrée",
        align = "c") %>%  
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em")

```

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole, contains("prop12_g"), -c("prop12_g_AST 2A")) %>%
  filter(annee_ecole == "1A") %>%
  arrange(desc(bloc_an)) %>%
  pivot_longer(
    cols = contains("prop12_g"),
    names_to = "filiere",
    values_to = "moyenne"
  ) %>%
  ggplot(aes(x = filiere, y = moyenne, fill = bloc_an)) +
  geom_col(position = "dodge") +
  labs(
    title = "1A : Moyennes Générales",
    x = "Filière d'entrée",
    y = "Moyenne"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

```

- UE Stat

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole,contains("prop12_stat"), -c("prop12_stat_AST 2A")) %>%  
  filter(annee_ecole == "1A") %>% 
  arrange(desc(bloc_an)) %>%  
  kable(format = "html", caption = "Nombre d'élèves selon la filière d'entrée",
        align = "c") %>%  
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em")

```

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole, contains("prop12_stat"), -c("prop12_stat_AST 2A")) %>%
  filter(annee_ecole == "1A") %>%
  arrange(desc(bloc_an)) %>%
  pivot_longer(
    cols = contains("prop12_stat"),
    names_to = "filiere",
    values_to = "moyenne"
  ) %>%
  ggplot(aes(x = filiere, y = moyenne, fill = bloc_an)) +
  geom_col(position = "dodge") +
  labs(
    title = "1A : Moyennes UE Stat",
    x = "Filière d'entrée",
    y = "Moyenne"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

```

- UE Info

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole,contains("prop12_inf"), -c("prop12_stat_AST 2A")) %>%  
  filter(annee_ecole == "1A") %>% 
  arrange(desc(bloc_an)) %>%  
  kable(format = "html", caption = "Nombre d'élèves selon la filière d'entrée",
        align = "c") %>%  
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em")
```

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole, contains("prop12_info"), -c("prop12_info_AST 2A")) %>%
  filter(annee_ecole == "1A") %>%
  arrange(desc(bloc_an)) %>%
  pivot_longer(
    cols = contains("prop12_info"),
    names_to = "filiere",
    values_to = "moyenne"
  ) %>%
  ggplot(aes(x = filiere, y = moyenne, fill = bloc_an)) +
  geom_col(position = "dodge") +
  labs(
    title = "1A : Moyennes UE Info",
    x = "Filière d'entrée",
    y = "Moyenne"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

```

- UE Éco

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole,contains("prop12_eco"), -c("prop12_stat_AST 2A")) %>%  
  filter(annee_ecole == "1A") %>% 
  arrange(desc(bloc_an)) %>%  
  kable(format = "html", caption = "Nombre d'élèves selon la filière d'entrée",
        align = "c") %>%  
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em")
```

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole, contains("prop12_eco"), -c("prop12_eco_AST 2A")) %>%
  filter(annee_ecole == "1A") %>%
  arrange(desc(bloc_an)) %>%
  pivot_longer(
    cols = contains("prop12_eco"),
    names_to = "filiere",
    values_to = "moyenne"
  ) %>%
  ggplot(aes(x = filiere, y = moyenne, fill = bloc_an)) +
  geom_col(position = "dodge") +
  labs(
    title = "1A : Moyennes UE Éco",
    x = "Filière d'entrée",
    y = "Moyenne"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

```

- UE Humanités

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole,contains("prop12_hum"), -c("prop12_hum_AST 2A")) %>%  
  filter(annee_ecole == "1A") %>% 
  arrange(desc(bloc_an)) %>%  
  kable(format = "html", caption = "Nombre d'élèves selon la filière d'entrée",
        align = "c") %>%  
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em")
```

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole, contains("prop12_hum"), -c("prop12_hum_AST 2A")) %>%
  filter(annee_ecole == "1A") %>%
  arrange(desc(bloc_an)) %>%
  pivot_longer(
    cols = contains("prop12_hum"),
    names_to = "filiere",
    values_to = "moyenne"
  ) %>%
  ggplot(aes(x = filiere, y = moyenne, fill = bloc_an)) +
  geom_col(position = "dodge") +
  labs(
    title = "1A : Moyennes UE Humanités",
    x = "Filière d'entrée",
    y = "Moyenne"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

```


### 2.2.2. En deuxième année

- Moyenne générale

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole,contains("prop12_g")) %>%  
  filter(annee_ecole == "2A") %>% 
  arrange(desc(bloc_an)) %>%  
  kable(format = "html", caption = "Nombre d'élèves selon la filière d'entrée",
        align = "c") %>%  
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em")

```

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole, contains("prop12_g")) %>%
  filter(annee_ecole == "2A") %>%
  arrange(desc(bloc_an)) %>%
  pivot_longer(
    cols = contains("prop12_g"),
    names_to = "filiere",
    values_to = "moyenne"
  ) %>%
  ggplot(aes(x = filiere, y = moyenne, fill = bloc_an)) +
  geom_col(position = "dodge") +
  labs(
    title = "1A : Moyennes Générales",
    x = "Filière d'entrée",
    y = "Moyenne"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

```


- UE Stat

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole,contains("prop12_stat")) %>%  
  filter(annee_ecole == "2A") %>% 
  arrange(desc(bloc_an)) %>%  
  kable(format = "html", caption = "Nombre d'élèves selon la filière d'entrée",
        align = "c") %>%  
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em")

```

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole, contains("prop12_stat")) %>%
  filter(annee_ecole == "2A") %>%
  arrange(desc(bloc_an)) %>%
  pivot_longer(
    cols = contains("prop12_stat"),
    names_to = "filiere",
    values_to = "moyenne"
  ) %>%
  ggplot(aes(x = filiere, y = moyenne, fill = bloc_an)) +
  geom_col(position = "dodge") +
  labs(
    title = "1A : Moyennes UE Stat",
    x = "Filière d'entrée",
    y = "Moyenne"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

```

- UE Info

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole,contains("prop12_inf")) %>%  
  filter(annee_ecole == "2A") %>% 
  arrange(desc(bloc_an)) %>%  
  kable(format = "html", caption = "Nombre d'élèves selon la filière d'entrée",
        align = "c") %>%  
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em")
```

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole, contains("prop12_info")) %>%
  filter(annee_ecole == "2A") %>%
  arrange(desc(bloc_an)) %>%
  pivot_longer(
    cols = contains("prop12_info"),
    names_to = "filiere",
    values_to = "moyenne"
  ) %>%
  ggplot(aes(x = filiere, y = moyenne, fill = bloc_an)) +
  geom_col(position = "dodge") +
  labs(
    title = "1A : Moyennes UE Info",
    x = "Filière d'entrée",
    y = "Moyenne"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

```

- UE Éco

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole,contains("prop12_eco")) %>%  
  filter(annee_ecole == "2A") %>% 
  arrange(desc(bloc_an)) %>%  
  kable(format = "html", caption = "Nombre d'élèves selon la filière d'entrée",
        align = "c") %>%  
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em")
```

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole, contains("prop12_eco")) %>%
  filter(annee_ecole == "2A") %>%
  arrange(desc(bloc_an)) %>%
  pivot_longer(
    cols = contains("prop12_eco"),
    names_to = "filiere",
    values_to = "moyenne"
  ) %>%
  ggplot(aes(x = filiere, y = moyenne, fill = bloc_an)) +
  geom_col(position = "dodge") +
  labs(
    title = "1A : Moyennes UE Éco",
    x = "Filière d'entrée",
    y = "Moyenne"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

```

- UE Humanités

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole,contains("prop12_hum")) %>%  
  filter(annee_ecole == "2A") %>% 
  arrange(desc(bloc_an)) %>%  
  kable(format = "html", caption = "Nombre d'élèves selon la filière d'entrée",
        align = "c") %>%  
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center",
    fixed_thead = TRUE
  ) %>%
  column_spec(1, width = "8em")
```

```{r}

bdd_bloc_1A_2A %>%
  select(bloc_an, annee_ecole, contains("prop12_hum")) %>%
  filter(annee_ecole == "1A") %>%
  arrange(desc(bloc_an)) %>%
  pivot_longer(
    cols = contains("prop12_hum"),
    names_to = "filiere",
    values_to = "moyenne"
  ) %>%
  ggplot(aes(x = filiere, y = moyenne, fill = bloc_an)) +
  geom_col(position = "dodge") +
  labs(
    title = "1A : Moyennes UE Humanités",
    x = "Filière d'entrée",
    y = "Moyenne"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )

```







## 3. Rang d'intégration et scolarité à l'ENSAI

### 2.1 Évolution des écarts de rang d'intégration entre attachés et ingénieurs (filière mathématiques)

Afin de comparer les rangs année par année et par filière, un rang standardisé est calculé pour chaque année. Il correspond à son rang au concours commun divisé par le rang maximum d'intégration à l'Ensai au concours commun.

```{r}

bdd_1a <- bdd[bdd$annee_ecole %in% c("1A"),]

bdd_1a_net <- bdd_1a[!duplicated(cbind(bdd_1a$id_crypte,bdd_1a$annee)),]

bdd_plot <- bdd_1a_net %>% 
  filter(!is.na(ccc_ran_com)) %>% 
  group_by(annee) %>% 
  mutate(max_annee = max(ccc_ran_com)) %>%   # max calculé par année
  group_by(annee, statut_etudiant) %>% 
  summarise(
    nb_math = n(),
    rang_moy_math = round(100 * mean(ccc_ran_com / max_annee), 1),
    rang_med_math = round(100 * median(ccc_ran_com / max_annee), 1),
    .groups = "drop"
  )

bdd_plot %>%
  kable(format = "html", caption = "Rangs d'intégration moyen et médian standardisés") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE, position = "center")

```


```{r}

ggplot(bdd_plot, aes(x = annee, y = rang_moy_math,
                        color = statut_etudiant, group = statut_etudiant)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Évolution du rang moyen au concours d'entrée spé maths par statut étudiant",
    x = "Année",
    y = "Rang moyen (%)",
    color = "Statut étudiant"
  ) +
  theme_minimal(base_size = 10) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "bottom"
  )

```

```{r}

bdd_box <- bdd_1a_net %>%
  filter(!is.na(ccc_ran_com)) %>%
  group_by(annee) %>%
  mutate(rang_std = 100 * ccc_ran_com / max(ccc_ran_com)) %>%  # standardisation par année
  ungroup() %>%
  mutate(annee = factor(annee))

ggplot(bdd_box,
       aes(x = annee, y = rang_std, fill = statut_etudiant)) +
  geom_boxplot(width = 0.7, alpha = 0.6, outlier.shape = NA, 
               position = position_dodge(width = 0.8)) +
  geom_jitter(aes(color = statut_etudiant),
              alpha = 0.35, size = 1,
              position = position_jitterdodge(jitter.width = 0.15, dodge.width = 0.8)) +
  labs(
    title = "Dispersion du rang standardisé (max par année)\npar année et statut étudiant",
    x = "Année",
    y = "Rang standardisé (%)",
    fill = "Statut étudiant",
    color = "Statut étudiant"
  ) +
  scale_y_continuous(limits = c(0, 100)) +
  theme_minimal(base_size = 10) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "bottom"
  )


```
